AJS.$.namespace("jira.app.wikipreview");jira.app.wikiPreview=function(prefs){var field,editField,trigger,origHtml,origText,setFields=function(prefs){field=AJS.$("#"+prefs.fieldId),editField=AJS.$("#"+prefs.fieldId+"-edit"),trigger=AJS.$("#"+prefs.trigger)},scrollSaver=function(){var elem;return{show:function(){if(!elem){elem=AJS.$("<div>").html("&nbsp;").css({height:"300px"}).insertBefore(editField)}elem.css({display:"block"})},hide:function(){elem.css({display:"none"})}}}(),toggleRenderPreview=function(){if(origHtml==null){editField.find(".content-inner").css({maxHeight:field.css("maxHeight")});this.showPreview()}else{editField.find(".content-inner").css({maxHeight:""});this.showInput()}},renderData=function(data){editField.originalHeight=editField.height();scrollSaver.show();origHtml=editField.addClass("previewClass").find(".content-inner").html();origText=field.val();trigger.removeClass("loading").addClass("selected");editField.find(".content-inner").html(data);scrollSaver.hide();editField.trigger("showWikiPreview",[editField])},handeError=function(previewer){return function(XMLHttpRequest,textStatus,errorThrown){trigger.removeClass("loading");origHtml=editField.find(".content-inner").html();origText=field.val();if(textStatus){alert(textStatus)}if(errorThrown){alert(errorThrown)}previewer.showInput()}};return{showPreview:function(){var that=this;var pid=AJS.$("#pid").val(),issueType=AJS.$("#issuetype").val();AJS.$("#"+prefs.trigger).addClass("loading");AJS.$.ajax({url:contextPath+"/rest/api/1.0/render",contentType:"application/json",type:"POST",data:JSON.stringify({rendererType:prefs.rendererType,unrenderedMarkup:field.val(),issueKey:prefs.issueKey,projectId:pid,issueType:issueType}),dataType:"html",success:renderData,error:handeError(that)})},showInput:function(e){if(editField){if(!e){scrollSaver.show();editField.css({height:""});editField.removeClass("previewClass").find(".content-inner").html(origHtml);field=AJS.$("#"+prefs.fieldId);field.val(origText);origHtml=null;trigger.removeClass("selected");scrollSaver.hide()}else{editField.find(".content-inner").append(origHtml)}field=AJS.$("#"+prefs.fieldId);field.val(origText);editField.trigger("showWikiInput",[editField])}},init:function(){var that=this;prefs=AJS.$.readData(prefs);AJS.$("#"+prefs.trigger).click(function(e){setFields(prefs);toggleRenderPreview.call(that);e.preventDefault()});AJS.$(document.getElementById(prefs.fieldId).form).submit(function(e){if(editField&&editField.hasClass("previewClass")){that.showInput(e)}})}}};AJS.$(function(){var wikiRenders=AJS.$(".wiki-js-prefs");wikiRenders.each(function(){var render=jira.app.wikiPreview(this);render.init()})});